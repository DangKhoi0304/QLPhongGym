{% extends "layout/base.html" %}

{% block title %}Hồ Sơ Của Tôi{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/hoso.css') }}">
<script src="{{ url_for('static', filename='js/hoso.js') }}"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">

                <div class="profile-banner-bg">
                    <h2 class="banner-text">THÔNG TIN CÁ NHÂN</h2>
                </div>

                <div class="card-body p-0">
                    <div class="row g-0">

                        <div class="col-md-4 text-center bg-light-subtle border-end position-relative">
                            <div class="p-4 pb-5">
                                <div class="avatar-wrapper mb-3 mt-n5 position-relative d-inline-block">
                                    <div class="avatar-box shadow-sm mx-auto overflow-hidden" id="avatar-container">
                                        {% set avatar_val = (current_user.avatar if current_user is defined else None) or (user_info.avatar if user_info is defined else None) %}
                                        {% if not avatar_val or avatar_val == 'default' %}
                                            <img src="{{ url_for('static', filename='images/default-avatar.jpg') }}"
                                                 class="w-100 rounded-circle object-fit-cover"
                                                 alt="Avatar">
                                        {% else %}
                                            <img src="{{ avatar_val }}"
                                                 class="w-100 h-100 rounded-circle object-fit-cover"
                                                 alt="Avatar">
                                        {% endif %}
                                    </div>

                                    <label for="avatar-upload"
                                           class="btn btn-primary btn-sm rounded-circle btn-upload-icon shadow-sm"
                                           data-bs-toggle="tooltip" title="Cập nhật ảnh đại diện">
                                        <i class="bi bi-camera-fill"></i>
                                    </label>
                                    <input type="file" id="avatar-upload" class="d-none" accept="image/*" data-url="{{ url_for('upload_avatar') }}">
                                </div>

                                <h4 class="fw-bold mb-1 text-dark">{{ user_info.hoTen }}</h4>
                                <p class="text-muted mb-4">@{{ user_info.taiKhoan }}</p>

                                <div class="mt-auto w-100 px-4">
                                    <button class="btn btn-outline-primary rounded-pill w-100 fw-bold mb-2"
                                            data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                        <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa hồ sơ
                                    </button>

                                    <button class="btn btn-outline-secondary rounded-pill w-100 fw-bold"
                                            data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                        <i class="bi bi-key-fill me-2"></i>Đổi mật khẩu
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8 bg-white fw-medium">
                            <div class="p-5">

                                <div class="row mb-2 align-items-center info-group">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-person-vcard me-3 fs-5 text-primary "></i>Họ và Tên
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark fs-5">
                                        {{ user_info.hoTen }}
                                    </div>
                                </div>

                                <div class="row mb-2 align-items-center info-group">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-gender-ambiguous me-3 fs-5 text-primary "></i>Giới tính
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark">
                                        {{ 'Nam' if user_info.gioiTinh else 'Nữ' }}
                                    </div>
                                </div>

                                <div class="row mb-2 align-items-center info-group">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-calendar-check me-3 fs-5 text-primary opacity-75"></i>Ngày đăng ký
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark">
                                        {% if user_info.NgayDangKy %}
                                            {{ user_info.NgayDangKy.strftime('%d/%m/%Y') }}
                                        {% else %}
                                            <span class="text-muted small">---</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-2 align-items-center info-group">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-envelope-at me-3 fs-5 text-primary "></i>Email
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark">
                                        {% if user_info.eMail and 'no-email' not in user_info.eMail %}
                                            {{ user_info.eMail }}
                                        {% else %}
                                            <span class="text-muted fst-italic fw-normal">Chưa cập nhật</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-2 align-items-center info-group">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-telephone me-3 fs-5 text-primary "></i>Điện thoại
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark">
                                        {{ user_info.SDT or 'Chưa cập nhật' }}
                                    </div>
                                </div>

                                <div class="row mb-2 align-items-center info-group">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-calendar-event me-3 fs-5 text-primary "></i>Ngày sinh
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark">
                                        {% if user_info.ngaySinh %}
                                            {{ user_info.ngaySinh.strftime('%d/%m/%Y') if user_info.ngaySinh.__class__.__name__ != 'str' else user_info.ngaySinh }}
                                        {% else %}
                                            <span class="text-muted fst-italic fw-normal">-</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row align-items-center info-group ">
                                    <div class="col-sm-4 text-secondary">
                                        <i class="bi bi-geo-alt me-3 fs-5 text-primary "></i>Địa chỉ
                                    </div>
                                    <div class="col-sm-8 fw-bold text-dark">
                                        {{ user_info.diaChi or 'Chưa cập nhật' }}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{# Modal chỉnh thông tin (gửi hidden action=update_profile) #}
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold text-primary">Cập Nhật Thông Tin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{{ url_for('ho_so', taikhoan=current_user.taiKhoan) }}">
        {{ form.hidden_tag() }}
        <input type="hidden" name="action" value="update_profile">

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form.hoTen.label }}</label>
            {{ form.hoTen(class="form-control", placeholder="Nhập họ và tên") }}
            {% for error in form.hoTen.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form.gioiTinh.label }}</label>
            {{ form.gioiTinh(class="form-select") }}
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form.ngaySinh.label }}</label>
            {{ form.ngaySinh(class="form-control", type="date") }}
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form.SDT.label }}</label>
            {{ form.SDT(class="form-control", placeholder="Nhập số điện thoại") }}
            {% for error in form.SDT.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form.diaChi.label }}</label>
            {{ form.diaChi(class="form-control", placeholder="Nhập địa chỉ") }}
          </div>
        </div>

        <div class="modal-footer border-top-0 pt-0">
          <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Hủy</button>
          {{ form.submit(class="btn btn-primary rounded-pill px-4") }}
        </div>
      </form>
    </div>
  </div>
</div>

{# Modal đổi mật khẩu (hidden action=change_password) #}
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold text-primary">Đổi mật khẩu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{{ url_for('ho_so', taikhoan=current_user.taiKhoan) }}">
        {{ form_pw.hidden_tag() }}
        <input type="hidden" name="action" value="change_password">

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form_pw.current_password.label }}</label>
            {{ form_pw.current_password(class="form-control", placeholder="Nhập mật khẩu hiện tại") }}
            {% for e in form_pw.current_password.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form_pw.new_password.label }}</label>
            {{ form_pw.new_password(class="form-control", placeholder="Mật khẩu mới") }}
            {% for e in form_pw.new_password.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">{{ form_pw.new_password2.label }}</label>
            {{ form_pw.new_password2(class="form-control", placeholder="Xác nhận mật khẩu mới") }}
            {% for e in form_pw.new_password2.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="modal-footer border-top-0 pt-0">
          <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Hủy</button>
          {{ form_pw.submit(class="btn btn-primary rounded-pill px-4") }}
        </div>
      </form>
    </div>
  </div>
</div>


{% endblock %}
