{% extends "layout/base.html" %}

{% block title %}Lên Lịch Tập Tuần{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="container mt-4">

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Soạn Giáo Án</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if member.avatar and member.avatar != 'default' %}
                        <img src="{{ member.avatar }}"
                             class="rounded-circle me-3" width="50" height="50"
                             style="object-fit: cover;" alt="Avatar">
                        {% else %}
                        <img src="{{ url_for('static', filename='images/default-avatar.jpg') }}"
                             class="rounded-circle me-3" width="50" height="50"
                             style="object-fit: cover;" alt="Default Avatar">
                        {% endif %}
                        <div>
                            <h6 class="mb-0 fw-bold">{{ member.hoTen }}</h6>
                            <small class="text-muted">Đang lên kế hoạch...</small>
                        </div>
                    </div>
                    <hr>

                    <form method="POST" id="formTaoLich" onsubmit="return validateForm()">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            {{ form.baiTap.label(class="form-label fw-bold") }}
                            {{ form.baiTap(class="form-control", list="list_goi_y", id="input_bai_tap",
                            placeholder="Nhập tên bài tập...", autocomplete="off") }}
                            <datalist id="list_goi_y">
                                {% for ten in goi_y_list %}
                                <option value="{{ ten }}">
                                    {% endfor %}
                            </datalist>
                            <div class="invalid-feedback" id="err_bai_tap">Vui lòng nhập tên bài tập.</div>
                        </div>

                        <div class="mb-3">
                            {{ form.nhomCo.label(class="form-label fw-bold") }}
                            {{ form.nhomCo(class="form-control bg-light", id="input_nhom_co", readonly=True,
                            placeholder="Tự động hoặc nhập tay...") }}

                            <div class="mt-1 small" id="msg_status">
                                <i class="fas fa-info-circle me-1"></i>Chọn bài mẫu sẽ tự điền nhóm cơ.
                            </div>
                            <div class="invalid-feedback" id="err_nhom_co">Vui lòng nhập nhóm cơ.</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                {{ form.soHiep.label(class="form-label fw-bold") }}
                                {{ form.soHiep(class="form-control", min="1", id="input_so_hiep") }}
                            </div>
                            <div class="col-6">
                                {{ form.soLan.label(class="form-label fw-bold") }}
                                {{ form.soLan(class="form-control", min="1", id="input_so_lan") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">Chọn ngày tập (*)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-calendar-alt text-primary"></i></span>
                                {{ form.ngayTap(class="form-control", id="datepicker", placeholder="Chạm để chọn
                                ngày...") }}
                                <div class="invalid-feedback" id="err_ngay_tap"
                                     style="display:none; width:100%; margin-top: 0.25rem; font-size: .875em; color: #dc3545;">
                                    Vui lòng chọn ít nhất một ngày tập!
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary fw-bold py-2">
                                <i class="fas fa-save me-2"></i> Lưu Lịch Tập
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lịch Đã Lưu</h5>
                    <span class="badge bg-light text-dark">{{ schedule|length }} bài</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th class="ps-3">Bài tập / Nhóm cơ</th>
                                <th class="text-center">Hiệp</th>
                                <th class="text-center">Lần</th>
                                <th>Lịch tập</th>
                                <th class="text-center" style="width: 120px;">Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for item in schedule %}
                            <tr>
                                <td class="ps-3">
                                    <div class="fw-bold text-primary">{{ item.baiTap }}</div>
                                    {% if item.nhom_co %}
                                    <span class="badge bg-info text-dark" style="font-size: 0.75rem;">
                                                {{ item.nhom_co }}
                                            </span>
                                    {% endif %}
                                </td>
                                <td class="text-center fw-bold">{{ item.soHiep }}</td>
                                <td class="text-center fw-bold">{{ item.soLan }}</td>
                                <td>
                                    {% set days = item.ngayTap.split(',') %}
                                    {% for day in days %}
                                    <div class="mb-1 small">
                                        <i class="fas fa-check text-success me-1"></i>{{ day.strip() }}
                                    </div>
                                    {% endfor %}
                                </td>

                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="{{ url_for('edit_schedule_item', id=item.id) }}"
                                           class="btn btn-warning btn-sm"
                                           title="Sửa bài tập">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('delete_schedule_item', id=item.id) }}"
                                           class="btn btn-danger btn-sm"
                                           onclick="return confirm('Xóa bài này?');"
                                           title="Xóa bài tập">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">Chưa có bài tập nào.</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // 1. Cấu hình Lịch
    const fp = flatpickr("#datepicker", {
        mode: "multiple",
        dateFormat: "d-m-Y",
        locale: "vn",
        minDate: "today",
        disableMobile: "true"
    });

    // 2. LOGIC XỬ LÝ NHÓM CƠ
    const exerciseMap = {{ data_map | tojson }};
    const inputBaiTap = document.getElementById('input_bai_tap');
    const inputNhomCo = document.getElementById('input_nhom_co');
    const msgStatus = document.getElementById('msg_status');

    function checkBaiTap() {
        const tenBai = inputBaiTap.value;
        if (exerciseMap && exerciseMap[tenBai]) {
            inputNhomCo.value = exerciseMap[tenBai];
            inputNhomCo.readOnly = true;
            inputNhomCo.classList.add('bg-light');
            inputNhomCo.classList.remove('bg-white');
            msgStatus.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>Đã lấy từ dữ liệu hệ thống.';
            msgStatus.className = "mt-1 small text-success";
        } else {
            if (tenBai.trim() !== "") {
                inputNhomCo.readOnly = false;
                inputNhomCo.classList.remove('bg-light');
                inputNhomCo.classList.add('bg-white');
                if (inputNhomCo.readOnly) inputNhomCo.value = "";
                msgStatus.innerHTML = '<i class="fas fa-pen text-warning me-1"></i>Bài mới: Vui lòng tự nhập nhóm cơ.';
                msgStatus.className = "mt-1 small text-warning fw-bold";
            } else {
                inputNhomCo.value = "";
                inputNhomCo.readOnly = true;
                inputNhomCo.classList.add('bg-light');
                msgStatus.innerHTML = '<i class="fas fa-info-circle me-1"></i>Chọn bài mẫu sẽ tự điền nhóm cơ.';
                msgStatus.className = "mt-1 small text-muted";
            }
        }
    }
    inputBaiTap.addEventListener('input', checkBaiTap);
    inputBaiTap.addEventListener('change', checkBaiTap);

    // 3. HÀM KIỂM TRA TRƯỚC KHI LƯU (VALIDATION)
    function validateForm() {
        let isValid = true;

        const valBaiTap = inputBaiTap.value.trim();
        const valNhomCo = inputNhomCo.value.trim();
        const valNgayTap = document.getElementById('datepicker').value.trim();

        inputBaiTap.classList.remove('is-invalid');
        inputNhomCo.classList.remove('is-invalid');
        document.getElementById('err_ngay_tap').style.display = 'none';

        if (valBaiTap === "") {
            inputBaiTap.classList.add('is-invalid');
            isValid = false;
        }

        if (valNhomCo === "") {
            inputNhomCo.classList.add('is-invalid');
            isValid = false;
        }

        if (valNgayTap === "") {
            document.getElementById('err_ngay_tap').style.display = 'block';
            isValid = false;
        }

        if (!isValid) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thiếu thông tin!',
                    text: 'Vui lòng nhập tên bài tập, nhóm cơ và chọn ít nhất một ngày tập.',
                    confirmButtonColor: '#d33'
                });
            } else {
                alert("Vui lòng nhập đầy đủ: Tên bài, Nhóm cơ và Chọn ngày tập!");
            }
            return false;
        }

        return true;
    }
</script>
{% endblock %}